<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta content="Aaqa Ishtyaq, Ramblings on programming, tech and life." name=description><title>Aaqa Ishtyaq</title><meta content="Setting up Scrapy Splash Plugin" name=title><meta content="Aaqa Ishtyaq" property=og:site_name><meta content=article property=og:type><meta content="Setting up Scrapy Splash Plugin" property=og:title><meta property=og:description><meta content=https://aaqa.dev/https://aaqa.dev/notes/scrapy-splash-setup/ property=og:url><meta content=2018-09-01 property=article:published_time><meta content=2018-09-01 property=article:modified_time><meta content=summary name=twitter:card><meta content="Setting up Scrapy Splash Plugin" name=twitter:title><meta name=twitter:description><meta content=https://aaqa.dev/https://aaqa.dev/notes/scrapy-splash-setup/ name=twitter:url><meta content=@aaqaishtyaq name=twitter:site><meta content="Written by" name=twitter:label1><meta content="Aaqa Ishtyaq" name=twitter:data1><meta content=@aaqaishtyaq name=twitter:creator><link href=https://aaqa.dev/theme.css rel=stylesheet><link href="https://aaqa.dev/ rss.xml" rel=alternate title=RSS type=application/rss+xml><script async data-token=aa8756e9-c3cd-41e6-8a91-e3c8203201db src=https://beamanalytics.b-cdn.net/beam.min.js></script><link as=font crossorigin href=/fonts/iosevka-regular.woff2 rel=preload type=font/woff2><body><div class=content><header><div class=header-left><a class=logo href=https://aaqa.dev/>Aaqa Ishtyaq</a></div><div class=header-right><nav itemscope itemtype=http://schema.org/SiteNavigationElement><ul><li class=nav><a href=https://aaqa.dev/notes/ itemprop=url> <span itemprop=name>Notes </span> </a><li class=nav><a href=https://aaqa.dev/reading/ itemprop=url> <span itemprop=name>Reading </span> </a><li class=nav><a href=https://aaqa.dev/travel/ itemprop=url> <span itemprop=name>Travel </span> </a><li class=nav><a href=https://aaqa.dev/tils/ itemprop=url> <span itemprop=name>TIL </span> </a><li class=nav><a href=https://aaqa.dev/uses/ itemprop=url> <span itemprop=name>Uses </span> </a><li class=nav><a href=https://aaqa.dev/contact/ itemprop=url> <span itemprop=name>Contact </span> </a><li class=nav><a href=/rss.xml itemprop=url> <span itemprop=name>Feed</span> </a></ul></nav></div></header><main><article itemscope itemtype=http://schema.org/BlogPosting><div itemprop=headline><h1>Setting up Scrapy Splash Plugin</h1><div class=border></div><div class=page-meta><time datetime=" 2018-09-01" class=date itemprop=datePublished> 01 Sep 2018 </time><div class=reading-time><div>1067 words, 5 minutes to read</div></div></div></div><div itemprop=articleBody><p>Scrapy is good for scraping static web pages using python but when it comes to dynamic web pages scrapy can't do wonders, and there comes <code>Selenium</code> but as good as selenium is, it just got beaten by Scrapy in terms or speed.<p>Web nowdays is all about Dynamic JS based pages and AJAX. So for this very scenario the guys over <a rel="noopener nofollow noreferrer" href=https://github.com/scrapy-plugins target=_blank>scrapy-plugins</a> created <code>scrapy-splash</code>. Scrapy-Splash is a plugin that connects Scrapy with Splash (Lightweight, scriptable browser as a service with an HTTP API). In a nutshell what splash do is it traps the response recieved from the server and renders it. Then it return a <code>render.html</code> which is static and can be easily scraped.<h2 id=0-setting-up-the-machine>0 - Setting up the machine</h2><p>A. Before we begin you need to install <code>Docker</code> first, You can follow the <a rel="noopener nofollow noreferrer" href=https://docs.docker.com/install/ target=_blank>official instruction</a> as per your Operating System.<p>B. After installing docker navigate to your project folder, activate <code>virtualenv</code> and install scrapy-splsh plugin<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">pip3</span></span><span class="z-meta z-function-call z-arguments z-shell"> install scrapy-splash</span>
</span></code></pre><p>C. Pull the Splash Docker Image and run it<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">docker</span></span><span class="z-meta z-function-call z-arguments z-shell"> pull scrapinghub/splash</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">docker</span></span><span class="z-meta z-function-call z-arguments z-shell"> run<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> 8050:8050 scrapinghub/splash</span>
</span></code></pre><h2 id=1-configuration>1 - Configuration</h2><p>A. Add the Splash server address to <code>settings.py</code> of your Scrapy project like this:<pre class="language-python z-code" data-lang=python><code class=language-python data-lang=python><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-other z-constant z-python">SPLASH_URL</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python"><span class="z-punctuation z-definition z-string z-begin z-python">'</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python">http://localhost:8050<span class="z-punctuation z-definition z-string z-end z-python">'</span></span></span>
</span></code></pre><p>If you are running docker on your local machine then you can simply use <code>http://localhost:&LTport></code> , but if you are running it on a remote machine you need to specify it's I.P. Address like this <code>http://192.168.59.103:&LTport></code><p>B. Enable the Splash middleware by adding it to <code>DOWNLOADER_MIDDLEWARES</code> in your <code>settings.py</code> file and changing HttpCompressionMiddleware priority:<pre class="language-python z-code" data-lang=python><code class=language-python data-lang=python><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-other z-constant z-python">DOWNLOADER_MIDDLEWARES</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-mapping-or-set z-python"><span class="z-punctuation z-section z-mapping-or-set z-begin z-python">{</span>
</span></span><span class="z-source z-python"><span class="z-meta z-mapping-or-set z-python"></span><span class="z-meta z-mapping z-python">    </span><span class="z-meta z-mapping z-key z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python"><span class="z-punctuation z-definition z-string z-begin z-python">'</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python">scrapy_splash.SplashCookiesMiddleware<span class="z-punctuation z-definition z-string z-end z-python">'</span></span></span></span><span class="z-meta z-mapping z-python"><span class="z-punctuation z-separator z-mapping z-key-value z-python">:</span></span><span class="z-meta z-mapping z-python"> </span><span class="z-meta z-mapping z-value z-python"><span class="z-constant z-numeric z-integer z-decimal z-python">723</span></span><span class="z-meta z-mapping z-python"><span class="z-punctuation z-separator z-mapping z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-mapping z-python">    </span><span class="z-meta z-mapping z-key z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python"><span class="z-punctuation z-definition z-string z-begin z-python">'</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python">scrapy_splash.SplashMiddleware<span class="z-punctuation z-definition z-string z-end z-python">'</span></span></span></span><span class="z-meta z-mapping z-python"><span class="z-punctuation z-separator z-mapping z-key-value z-python">:</span></span><span class="z-meta z-mapping z-python"> </span><span class="z-meta z-mapping z-value z-python"><span class="z-constant z-numeric z-integer z-decimal z-python">725</span></span><span class="z-meta z-mapping z-python"><span class="z-punctuation z-separator z-mapping z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-mapping z-python">    </span><span class="z-meta z-mapping z-key z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python"><span class="z-punctuation z-definition z-string z-begin z-python">'</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python">scrapy.downloadermiddlewares.httpcompression.HttpCompressionMiddleware<span class="z-punctuation z-definition z-string z-end z-python">'</span></span></span></span><span class="z-meta z-mapping z-python"><span class="z-punctuation z-separator z-mapping z-key-value z-python">:</span></span><span class="z-meta z-mapping z-python"> </span><span class="z-meta z-mapping z-value z-python"><span class="z-constant z-numeric z-integer z-decimal z-python">810</span></span><span class="z-meta z-mapping z-python"><span class="z-punctuation z-separator z-mapping z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-mapping z-python"><span class="z-punctuation z-section z-mapping z-end z-python">}</span></span>
</span></code></pre><p>C. Enable SplashDeduplicateArgsMiddleware by adding it to SPIDER_MIDDLEWARES in your settings.py:<pre class="language-python z-code" data-lang=python><code class=language-python data-lang=python><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-other z-constant z-python">SPIDER_MIDDLEWARES</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-mapping-or-set z-python"><span class="z-punctuation z-section z-mapping-or-set z-begin z-python">{</span>
</span></span><span class="z-source z-python"><span class="z-meta z-mapping-or-set z-python"></span><span class="z-meta z-mapping z-python">    </span><span class="z-meta z-mapping z-key z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python"><span class="z-punctuation z-definition z-string z-begin z-python">'</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python">scrapy_splash.SplashDeduplicateArgsMiddleware<span class="z-punctuation z-definition z-string z-end z-python">'</span></span></span></span><span class="z-meta z-mapping z-python"><span class="z-punctuation z-separator z-mapping z-key-value z-python">:</span></span><span class="z-meta z-mapping z-python"> </span><span class="z-meta z-mapping z-value z-python"><span class="z-constant z-numeric z-integer z-decimal z-python">100</span></span><span class="z-meta z-mapping z-python"><span class="z-punctuation z-separator z-mapping z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-mapping z-python"><span class="z-punctuation z-section z-mapping z-end z-python">}</span></span>
</span></code></pre><p>D. Set a custom DUPEFILTER_CLASS:<pre class="language-python z-code" data-lang=python><code class=language-python data-lang=python><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-other z-constant z-python">DUPEFILTER_CLASS</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python"><span class="z-punctuation z-definition z-string z-begin z-python">'</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python">scrapy_splash.SplashAwareDupeFilter<span class="z-punctuation z-definition z-string z-end z-python">'</span></span></span>
</span></code></pre><h2 id=2-scraping-with-splash>2 - Scraping with Splash</h2><p>Before you use <code>scrapy-splash</code> you need to import it in your spider. You can do that by adding this line:<pre class="language-python z-code" data-lang=python><code class=language-python data-lang=python><span class="z-source z-python"><span class="z-meta z-statement z-import z-python"><span class="z-keyword z-control z-import z-from z-python">from</span></span><span class="z-meta z-statement z-import z-python"><span class="z-meta z-import-source z-python"> <span class="z-meta z-import-path z-python"><span class="z-meta z-import-name z-python">scrapy_splash</span></span> <span class="z-meta z-statement z-import z-python"><span class="z-keyword z-control z-import z-python">import</span></span></span></span><span class="z-meta z-statement z-import z-python"></span><span class="z-meta z-statement z-import z-python"> <span class="z-meta z-generic-name z-python">SplashRequest</span></span>
</span></code></pre><p>from now on insted of using <code>scrapy.Request</code> you can simply use <code>SplashRequest</code> to get response from <code>Splash</code> insted of directly from ther server.<h2 id=bonus-using-scrapy-splash-in-shell>Bonus - Using Scrapy-Splash in Shell</h2><p>It's all well and good but actual spider buiding does not happens in <code>vim</code> or <code>sublime</code>, it takes place in <code>shell</code>.<p><strong>So how to use Splash in the shell?</strong><p>Good Question.<p>Insted of invoking shell with:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">scrapy</span></span><span class="z-meta z-function-call z-arguments z-shell"> shell</span>
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-operator z-assignment z-redirection z-shell">>></span><span class="z-keyword z-operator z-assignment z-redirection z-shell">></span> fetch<span class="z-punctuation z-definition z-compound z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">http://domain.com/page-with-javascript.html</span></span><span class="z-punctuation z-definition z-compound z-end z-shell">)</span>
</span></code></pre><p>or with this:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">scrapy</span></span><span class="z-meta z-function-call z-arguments z-shell"> shell http://domain.com/page-with-javascript.html</span>
</span></code></pre><p><strong>You invoke shell with this</strong>:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">scrapy</span></span><span class="z-meta z-function-call z-arguments z-shell"> shell <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>http://localhost:8050/render.html?url=http://domain.com/page-with-javascript.html&timeout=10&wait=0.5<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span></span>
</span></code></pre><p>Let me explain<ul><li><code>localhost:port</code> is where your splash service is running<li><code>url</code> is url you want to crawl<li><code>render.html</code> is one of the possible http api endpoints, returns redered html page in this case<li><code>timeout</code> time in seconds for timeout<li><code>wait</code> time in seconds to wait for javascript to execute before reading/saving the html.</ul><p>If I’ve missed something, made a horrible mistake of if you have any questions regarding this article then feel free to ping me on Twitter. I’m <a rel="noopener nofollow noreferrer" href=https://twitter.com/aaqaishtyaq target=_blank>@aaqaishtyaq</a>.</div></article></main><footer><div class=border></div><div class=footer><small class=footer-left> Copyright © Aaqa Ishtyaq </small><small class=footer-right> Links: <a href=https://github.com/aaqaishtyaq target=_blank>Github</a> | <a href=https://linkedin.com/in/aaqaishtyaq target=_blank>LinkedIn</a> </small></div><br><small class=footer> <a class=pgp href=https://keys.openpgp.org/vks/v1/by-fingerprint/AFB766F59A198D35DD8F925AC4BE1CE588EB9E21 target=_blank> AFB7 66F5 9A19 8D35 DD8F 925A C4BE 1CE5 88EB 9E21 </a> </small></footer></div>