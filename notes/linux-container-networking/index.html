<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta content="Aaqa Ishtyaq, Ramblings on programming, tech and life." name=description><title>Aaqa Ishtyaq</title><meta content="Linux Container Networking from Scratch" name=title><meta content="Aaqa Ishtyaq" property=og:site_name><meta content=article property=og:type><meta content="Linux Container Networking from Scratch" property=og:title><meta property=og:description><meta content=https://aaqa.dev/https://aaqa.dev/notes/linux-container-networking/ property=og:url><meta content=2023-01-26 property=article:published_time><meta content=2023-01-26 property=article:modified_time><meta content=summary name=twitter:card><meta content="Linux Container Networking from Scratch" name=twitter:title><meta name=twitter:description><meta content=https://aaqa.dev/https://aaqa.dev/notes/linux-container-networking/ name=twitter:url><meta content=@aaqaishtyaq name=twitter:site><meta content="Written by" name=twitter:label1><meta content="Aaqa Ishtyaq" name=twitter:data1><meta content=@aaqaishtyaq name=twitter:creator><link href=https://aaqa.dev/theme.css rel=stylesheet><link href="https://aaqa.dev/ rss.xml" rel=alternate title=RSS type=application/rss+xml><script async data-token=aa8756e9-c3cd-41e6-8a91-e3c8203201db src=https://beamanalytics.b-cdn.net/beam.min.js></script><link as=font crossorigin href=/fonts/iosevka-regular.woff2 rel=preload type=font/woff2><body><div class=content><header><div class=header-left><a class=logo href=https://aaqa.dev/>Aaqa Ishtyaq</a></div><div class=header-right><nav itemscope itemtype=http://schema.org/SiteNavigationElement><ul><li class=nav><a href=https://aaqa.dev/notes/ itemprop=url> <span itemprop=name>Notes </span> </a><li class=nav><a href=https://aaqa.dev/reading/ itemprop=url> <span itemprop=name>Reading </span> </a><li class=nav><a href=https://aaqa.dev/travel/ itemprop=url> <span itemprop=name>Travel </span> </a><li class=nav><a href=https://aaqa.dev/tils/ itemprop=url> <span itemprop=name>TIL </span> </a><li class=nav><a href=https://aaqa.dev/uses/ itemprop=url> <span itemprop=name>Uses </span> </a><li class=nav><a href=https://aaqa.dev/contact/ itemprop=url> <span itemprop=name>Contact </span> </a><li class=nav><a href=/rss.xml itemprop=url> <span itemprop=name>Feed</span> </a></ul></nav></div></header><main><article itemscope itemtype=http://schema.org/BlogPosting><div itemprop=headline><h1>Linux Container Networking from Scratch</h1><div class=border></div><div class=page-meta><time datetime=" 2023-01-26" class=date itemprop=datePublished> 26 Jan 2023 </time><div class=reading-time><div>2839 words, 14 minutes to read</div></div></div></div><div itemprop=articleBody><p>In this article, we will be looking into setting up networking on a linux box from scratch.<p>We will be creating a fresh new VM using Lima on macOS. You can create a new VM using VirtualBox, Vagrant, or even create a VM on OCI for free.<h2 id=isolation-based-on-network-namespace>Isolation based on Network Namespace</h2><p>The common thing that constitutes a network stack includes the:<ul><li>Network Devices<li>Routing Rules<li>Netfilter Hooks</ul><p>We can create a non-comprehensive <code>inspect-net-stack</code> script.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell">!/usr/bin/env bash</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>> Network devices<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ip</span></span><span class="z-meta z-function-call z-arguments z-shell"> link</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">-</span>e</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>\n> Route table<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ip</span></span><span class="z-meta z-function-call z-arguments z-shell"> route</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">-</span>e</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>\n> Iptables rules<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">iptables</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>list-rules</span></span>
</span></code></pre><p>After the execution of the inspect script on my machine produces the following input:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span></span></span></span><span class="z-meta z-function-call z-arguments z-shell"> sudo ./inspect-net-stack</span>
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-operator z-assignment z-redirection z-shell">></span> Network <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">devices</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1:</span></span><span class="z-meta z-function-call z-arguments z-shell"> lo: <span class="z-keyword z-operator z-assignment z-redirection z-shell"><</span>LOOPBACK,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">></span> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/loopback</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:00:00:00:00:00 brd 00:00:00:00:00:00</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">2:</span></span><span class="z-meta z-function-call z-arguments z-shell"> eth0: <span class="z-keyword z-operator z-assignment z-redirection z-shell"><</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="z-keyword z-operator z-assignment z-redirection z-shell">></span> mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/ether</span></span><span class="z-meta z-function-call z-arguments z-shell"> 52:55:55:a3:ad:92 brd ff:ff:ff:ff:ff:ff</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">altname</span></span><span class="z-meta z-function-call z-arguments z-shell"> enp0s1</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-operator z-assignment z-redirection z-shell">></span> Route <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">table</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">default</span></span><span class="z-meta z-function-call z-arguments z-shell"> via 192.168.5.3 dev eth0 proto dhcp src 192.168.5.15 metric 100</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">192.168.5.0/24</span></span><span class="z-meta z-function-call z-arguments z-shell"> dev eth0 proto kernel scope link src 192.168.5.15 metric 100</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-operator z-assignment z-redirection z-shell">></span> Iptables <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">rules</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-P</span></span><span class="z-meta z-function-call z-arguments z-shell"> INPUT ACCEPT</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-P</span></span><span class="z-meta z-function-call z-arguments z-shell"> FORWARD ACCEPT</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-P</span></span><span class="z-meta z-function-call z-arguments z-shell"> OUTPUT ACCEPT</span>
</span></code></pre><p>We want to make sure that each of the containers we are going to create soon will get a separate network stack.<p>Linux namespaces used for container isolation are called <a rel="noopener nofollow noreferrer" href=https://man7.org/linux/man-pages/man8/ip-netns.8.html target=_blank>network namespaces</a>. We won't be creating the fully isolated container, rather restrict the scope to only the network stack. One of the ways to create a network stack is by using the <code>ip</code> tool, part of <a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Iproute2 target=_blank><code>iproute2</code></a><pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span></span></span></span><span class="z-meta z-function-call z-arguments z-shell"> sudo ip netns add netns0</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span></span></span></span><span class="z-meta z-function-call z-arguments z-shell"> ip netns</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">netns0</span></span>
</span></code></pre><p>We have a new network namespace but to start using the network namespace, We can use a command called <code>nsenter</code>. It enters one or more of the specified namespaces and then executes the given program:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> This is create a new bash process under netns0 namespace</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span></span></span></span><span class="z-meta z-function-call z-arguments z-shell"> sudo nsenter<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>net</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>/var/run/netns/netns0 bash</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span></span></span></span><span class="z-meta z-function-call z-arguments z-shell"> sudo ./inspect-net-stack</span>
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-operator z-assignment z-redirection z-shell">></span> Network <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">devices</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1:</span></span><span class="z-meta z-function-call z-arguments z-shell"> lo: <span class="z-keyword z-operator z-assignment z-redirection z-shell"><</span>LOOPBACK<span class="z-keyword z-operator z-assignment z-redirection z-shell">></span> mtu 65536 qdisc noop state DOWN mode DEFAULT group default qlen 1000</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">link/loopback</span></span><span class="z-meta z-function-call z-arguments z-shell"> 00:00:00:00:00:00 brd 00:00:00:00:00:00</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-operator z-assignment z-redirection z-shell">></span> Route <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">table</span></span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-operator z-assignment z-redirection z-shell">></span> Iptables <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">rules</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-P</span></span><span class="z-meta z-function-call z-arguments z-shell"> INPUT ACCEPT</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-P</span></span><span class="z-meta z-function-call z-arguments z-shell"> FORWARD ACCEPT</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-P</span></span><span class="z-meta z-function-call z-arguments z-shell"> OUTPUT ACCEPT</span>
</span></code></pre><p>As you can see from the above output, the <code>bash</code> process running inside the <code>netns0</code> namespace sees a different network stack. There are no routing rules and no custom iptables chain. Only one loopback device (<code>lo</code>).<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash">                        <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Network</span></span><span class="z-meta z-function-call z-arguments z-shell"> Namespace</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">┌─────────────────────────────────────────────────────────────────────┐</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell">                                                                     │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell">                                          Root Namespace             │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell">                                                                     │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell"> lo0                    ┌────────────────────────────────────────┐   │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell"> ┌─┐                    │                                        │   │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell"> │ │                    │    lo0             Container Namespace │   │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell"> │ │                    │    ┌─┐              netns0             │   │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell"> │ │    ┌────────────┐  │    │ │                                 │   │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell"> │ │    │            │  │    │ │  ┌───────────┐                  │   │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell"> │ │    │ routes     │  │    │ │  │           │                  │   │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell"> │ │    │            │  │    │ │  │routes     │                  │   │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell"> │ │    └────────────┘  │    │ │  └───────────┘                  │   │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell"> └─┘                    │    └─┘                                 │   │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell">                        │                                        │   │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell"> ┌─┐    ┌────────────┐  │         ┌───────────┐                  │   │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell"> │ │    │            │  │         │           │                  │   │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell"> │ │    │ iptables   │  │         │iptables   │                  │   │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell"> │ │    │            │  │         └───────────┘                  │   │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell"> │ │    └────────────┘  │                                        │   │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell"> │ │                    │                                        │   │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell"> │ │                    │                                        │   │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell"> └─┘                    │                                        │   │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell"> eth0                   └────────────────────────────────────────┘   │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell">                                                                     │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell">                                                                     │</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">└─────────────────────────────────────────────────────────────────────┘</span></span>
</span></code></pre><p><em>Beware</em>: The <code>nsenter</code> command from above started a nested bash session in the netns0 network namespace. Don't forget to exit from it.<hr><p>In the upcoming posts, I will discuss connecting the host with this namespace. Interconnecting various network switches, Just like patching the physical switch with a LAN cable.</div></article></main><footer><div class=border></div><div class=footer><small class=footer-left> Copyright © Aaqa Ishtyaq </small><small class=footer-right> Links: <a href=https://github.com/aaqaishtyaq target=_blank>Github</a> | <a href=https://linkedin.com/in/aaqaishtyaq target=_blank>LinkedIn</a> </small></div><br><small class=footer> <a class=pgp href=https://keys.openpgp.org/vks/v1/by-fingerprint/AFB766F59A198D35DD8F925AC4BE1CE588EB9E21 target=_blank> AFB7 66F5 9A19 8D35 DD8F 925A C4BE 1CE5 88EB 9E21 </a> </small></footer></div>